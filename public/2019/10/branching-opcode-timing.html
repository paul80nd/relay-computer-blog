<!DOCTYPE html>
<html lang="en">

  <head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Branching: Opcode Timing | Relay Computer</title>
<meta name="generator" content="Jekyll v3.7.4" />
<meta property="og:title" content="Branching: Opcode Timing" />
<meta name="author" content="Paul Law" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="In my last post I covered the design for the GOTO opcode which will enable my relay computer to perform branching, loops and so on. Here’s where I got to last time:" />
<meta property="og:description" content="In my last post I covered the design for the GOTO opcode which will enable my relay computer to perform branching, loops and so on. Here’s where I got to last time:" />
<link rel="canonical" href="https://relaycomputer.co.uk/2019/10/branching-opcode-timing" />
<meta property="og:url" content="https://relaycomputer.co.uk/2019/10/branching-opcode-timing" />
<meta property="og:site_name" content="Relay Computer" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-10-06T02:00:00+01:00" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"Paul Law"},"url":"https://relaycomputer.co.uk/2019/10/branching-opcode-timing","description":"In my last post I covered the design for the GOTO opcode which will enable my relay computer to perform branching, loops and so on. Here’s where I got to last time:","headline":"Branching: Opcode Timing","@type":"BlogPosting","datePublished":"2019-10-06T02:00:00+01:00","dateModified":"2019-10-06T02:00:00+01:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://relaycomputer.co.uk/2019/10/branching-opcode-timing"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

<!-- Begin CSS Styles -->
<link href="https://fonts.googleapis.com/css?family=PT+Serif:400,500,700" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Lato:300,400,500,700" rel="stylesheet">
<link href="https://use.fontawesome.com/releases/v5.0.8/css/all.css" rel="stylesheet">
<link rel="stylesheet" href="/assets/css/app.css">
<!-- End CSS Styles -->



<link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicon/apple-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicon/apple-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicon/apple-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicon/apple-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicon/apple-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicon/apple-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicon/apple-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicon/apple-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicon/apple-icon-180x180.png">
<link rel="icon" type="image/png" sizes="192x192"  href="/assets/img/favicon/android-icon-192x192.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicon/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicon/favicon-96x96.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicon/favicon-16x16.png">
<link rel="manifest" href="/assets/img/favicon/manifest.json">
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="/assets/img/favicon/ms-icon-144x144.png">
<meta name="theme-color" content="#ffffff">
<link type="application/atom+xml" rel="alternate" href="https://relaycomputer.co.uk/feed.xml" title="Relay Computer" />

<!-- Begin EU Cookie Consent -->
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#000"
    },
    "button": {
      "background": "#f1d600"
    }
  }
})});
</script>
<!-- End EU Cookie Consent -->


    <!-- Google Analytics -->
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-47484999-2', 'auto');
	ga('send', 'pageview', { 'page': location.pathname + location.search + location.hash});
	ga('set', 'anonymizeIp', false);
    </script>
    <!-- End Google Analytics -->
    </head>


  <body>
      <nav class="navbar is-primary" >
        <div class="container">
            <div class="navbar-brand">
                <a href="/" class="navbar-item">
                    Relay Computer
                </a>
                <a role="button" class="navbar-burger burger" aria-label="menu" aria-expanded="false" data-target="navMenu">
                    <span aria-hidden="true"></span>
                    <span aria-hidden="true"></span>
                    <span aria-hidden="true"></span>
                </a>
            </div>
            <div class="navbar-menu" id="navMenu">
                <div class="navbar-start">
                    <a href="/" class="navbar-item ">Home</a>
                    
                    
                        
                        <a href="/pages/overview.html" class="navbar-item ">Overview</a>
                        
                    
                        
                        <div class="navbar-item has-dropdown is-hoverable">
                            <a href="/#" class="navbar-link ">Summaries</a>
                            <div class="navbar-dropdown">
                                
                                <a href="/pages/progress.html" class="navbar-item ">Progress</a>
                                
                                <a href="/pages/instructions.html" class="navbar-item ">Instructions</a>
                                
                                <a href="/pages/alu.html" class="navbar-item ">ALU</a>
                                
                                <a href="/pages/control.html" class="navbar-item ">Control</a>
                                
                                <a href="/pages/enclosure.html" class="navbar-item ">Enclosure</a>
                                
                                <a href="/pages/registers.html" class="navbar-item ">Registers</a>
                                
                                <a href="/pages/ui.html" class="navbar-item ">UI</a>
                                
                            </div>
                        </div>
                        
                    
                        
                        <a href="/archive.html" class="navbar-item ">Archive</a>
                        
                    
                        
                        <a href="/tags.html" class="navbar-item ">Tags</a>
                        
                    
                    
                </div>
            </div>
        </div>
    </nav>

      
        <section class="hero is-bold is-primary" >
    <div class="hero-body">
        <div class="container">                
            <h1 class="title ">Branching: Opcode Timing</h1>
            <h2 class="subtitle"></h2>
        </div>
    </div>
</section>
      

      <section class="section">
        <div class="container">
              <div class="columns">
  <div class="column is-three-quarters-widescreen">
    <div class="content">

      <p>In my last post I covered the design for the GOTO opcode which will enable my relay computer to perform branching, loops and so on. Here’s where I got to last time:</p>

<article class="box">
    <div class="content">
        <h4>Branch/Call &amp; 16-bit Load Immediate</h4>
        <div class="field is-grouped is-grouped-multiline is-family-monospace">
            <div class="control">
                <div class="tags has-addons are-medium">
                    <span class="tag is-primary">GOTO</span>
                    <span class="tag is-success">24</span>
                </div>
            </div>              
            <div class="control">
                <div class="tags has-addons are-medium" style="margin-bottom: 0;">
                    <span class="tag is-link">1</span>
                    <span class="tag is-link">1</span>
                    <span class="tag is-info">d</span>
                    <span class="tag is-info">s</span>
                    <span class="tag is-info">c</span>
                    <span class="tag is-info">z</span>
                    <span class="tag is-info">n</span>
                    <span class="tag is-info">x</span>
                </div>
                
                <div class="tags has-addons are-medium" style="margin-bottom: 0;">
                    <span class="tag is-info">h</span>
                    <span class="tag is-info">h</span>
                    <span class="tag is-info">h</span>
                    <span class="tag is-info">h</span>
                    <span class="tag is-info">h</span>
                    <span class="tag is-info">h</span>
                    <span class="tag is-info">h</span>
                    <span class="tag is-info">h</span>
                </div>
                <div class="tags has-addons are-medium" style="margin-bottom: 0;">
                    <span class="tag is-info">l</span>
                    <span class="tag is-info">l</span>
                    <span class="tag is-info">l</span>
                    <span class="tag is-info">l</span>
                    <span class="tag is-info">l</span>
                    <span class="tag is-info">l</span>
                    <span class="tag is-info">l</span>
                    <span class="tag is-info">l</span>
                </div>
                
            </div>        
        </div>
        <pre class="is-size-7"><code>d = destination register (0-M, 1-J)<br />s = 1 = load PC if sign bit is set (if negative); 0 = ignore sign bit<br />c = 1 = load PC if carry bit is set (if carry); 0 = ignore carry bit<br />z = 1 = load PC if zero bit set (if result is zero); 0 = ignore if zero bit set<br />n = 1 = load PC if zero bit clear (if result is not zero); 0 = ignore if zero bit clear<br />x = 1 = copy PC to XY; 0 = no copy<br />hhhhhhhh = address high byte (to set in M2/J2)<br />llllllll = address low byte (to set in M1/J1)</code></pre>
    </div> 
</article>

<p>The opcode can also be drawn in diagram form as follows:</p>

<figure><img src="/assets/img/posts/2019/2019-10-06-0000.png" alt="GOTO opcode map" />
  
</figure>

<p>As mentioned in my last post this is by far the most complicated opcode to date … and in fact, this will be the most
complicated opcode the computer is going to get. The next job is to take the design above and derive some timing diagrams to
show which control lines will be operated at what time so that the opcode functions as desired. Before we get stuck in lets
remind ourselves of what happens at the beginning of all opcodes:</p>

<figure><img src="/assets/img/posts/2019/2019-10-06-0001.png" alt="fetch increment timing" />
  
</figure>

<p>This is the ‘fetch/increment’ cycle which loads the opcode in to the instruction register and then moves the program counter
on to the next instruction in memory. In the case of GOTO we have three bytes … the opcode itself followed by a 16-bit
address to potentially jump to. This means that after the fetch/increment the program counter is now pointing to the lower
8-bits of that 16-bit address.</p>

<p>So, what’s needed is to load that in to either M1 or J1 and increment the program counter once
again. That gets us pointing to the upper 8-bits of the address so we repeat similarly to load either M2 or J2 and increment
one last time. That finally gets us in to the state where the program counter is pointing to the next instruction just like
any other opcode would. If we do decide to make the jump to the given address we’ll re-point the program counter otherwise
we’ll continue as normal. Let’s do a basic map of this:</p>

<figure><img src="/assets/img/posts/2019/2019-10-06-0002.png" alt="loading M or J register" />
  
</figure>

<p>All this, of course, needs to happen after the initial fetch/increment as the address and data busses will be busy during that
time. We’ll also leave a gap between those operations to ensure any required busses are clear.</p>

<p>Timing wise that covers most of the heavy lifting for this opcode. With the program counter pointing to the next instruction in memory we can optionally load the XY register from that so we can return back from a jump (the last bit of the opcode
tells us if this is wanted or not). Finally we need to decide to take the jump itself or not. The jump address
will have been loaded in to the J register (jumps from M aren’t supported) and all we need to do, if we are jumping, is copy
that value to the program counter meaning the computer will continue execution from the given address. Here’s the timing with
these last two steps added in.</p>

<figure><img src="/assets/img/posts/2019/2019-10-06-0003.png" alt="loading, return address and jump" />
  
</figure>

<p>Putting everything together we end up with the final GOTO timing chart:</p>

<figure><img src="/assets/img/posts/2019/2019-10-06-0004.png" alt="GOTO opcode timing chart" />
  
  <figcaption>GOTO opcode timing chart (<a href="/assets/img/posts/2019/2019-10-06-1004.png">larger</a>)</figcaption>
</figure>

<p>So, we now know what needs to happen and when but how does this get implemented in the computer? Well, just as with the other
instructions, you look at the timing diagram and pick out the common pulse shapes which we can create in the sequencer. The
controller will then use these pulses to operate the control lines as per our timing diagram.</p>

<p>So far the sequencer counts up to 8 ticks of the clock (each tick being a rising or falling edge of the clock signal). That’s
been enough to operate the instructions created so far given I’ve been able to utilise the data bus whilst the address bus is
finishing off the increment of the program counter. In this particular case I’ve got to wait for all that to happen and even
then I’ve got to cycle through the next two bytes of the instruction. All in all I’ll need to go all the way up to 24 ticks
to fit this instruction in.</p>

<p>Given this is the longest instruction it’s probably about time to finish off the sequencer design so that it can produce the
pulses for not only this instruction but all the others I’ll be implementing. That certainly deserves its own post so I’ll
cover that off next time.</p>


    </div>

    <div class="field is-grouped is-grouped-multiline">
      <div class="control">
        <a href="/archive#2019" class="tags has-addons">
          <span class="tag is-link">Published</span>
          <span class="tag is-info">Oct 6, 2019</span>
        </a>
      </div>
      
      <div class="control">
        <a href="/tags#theory" class="tags">
          <span class="tag is-primary">theory</span>
        </a>
      </div>
      
      <div class="control">
        <a href="/tags#sequencing" class="tags">
          <span class="tag is-primary">sequencing</span>
        </a>
      </div>
      
      <div class="control">
        <a href="/tags#design" class="tags">
          <span class="tag is-primary">design</span>
        </a>
      </div>
      
      <div class="control">
        <a href="/tags#control" class="tags">
          <span class="tag is-primary">control</span>
        </a>
      </div>
      
    </div>

    <div class="columns">
      <div class="column">
        
          <span class="has-text-weight-semibold">Previous Post</span><br />
          <a href="/2019/09/branching-opcode-design">Branching: Opcode Design</a>
                
      </div>
      <div class="column has-text-right">
        
          <span class="has-text-weight-semibold">Next Post</span><br />
          <a href="/2019/11/sequencer-design-24-cycle-fsm">Sequencer Design: 24-cycle FSM</a>
                
      </div>
    </div>

  </div>
</div>
        </div>
      </section>
          
      <footer class="footer">
    <div class="container">
        <div class="columns">
            <div class="column">   
                <h3>On this blog</h3>  
                <p><a href="/index.html">Home</a></p>
                <p><a href="/archive">Archive</a></p>
                <p><a href="/tags">Tags</a></p>
                <p><a href="/pages/progress">Progress</a></p>
            </div>        
            <div class="column">
                <h3>Related sites</h3>
                <p><a href="https://www.youtube.com/channel/UCDn07eKw2HDPIgSAGQgliAA"><span class="fab fa-youtube fa-lg fa-fw"></span> YouTube Channel</a></p>
                <p><a href="https://github.com/paul80nd"><span class="fab fa-github fa-lg fa-fw"></span> GitHub Repos</a></p>
                <p><a href="http://simulator.relaycomputer.co.uk"><span class="fas fa-flask fa-lg fa-fw"></span> Relay Simulator</a></p>
            </div>
            <div class="column">
                <h3>Share on social media</h3>
                <p><a href="https://www.facebook.com/sharer/sharer.php?u=&amp;quote=" target="_blank"><span class="fab fa-facebook fa-lg fa-fw"></span> Share on Facebook</a></p>
                <p><a href="https://twitter.com/intent/tweet?source=&amp;text=" target="_blank"><span class="fab fa-twitter fa-lg fa-fw"></span> Tweet</a></p>
                <p><a href="http://www.tumblr.com/share?v=3&amp;u=&amp;quote=&amp;s=" target="_blank"><span class="fab fa-tumblr fa-lg fa-fw"></span> Post to Tumblr</a></p> 
                <p><a href="http://pinterest.com/pin/create/button/?url=&amp;description=" target="_blank"><span class="fab fa-pinterest fa-lg fa-fw"></span> Pin it</a></p> 
                <p><a href="http://www.reddit.com/submit?url=&amp;title=" target="_blank"><span class="fab fa-reddit fa-lg fa-fw"></span> Submit to Reddit</a></p>   
                <p><a href="mailto:?subject=&amp;body=" target="_blank"><span class="fas fa-envelope fa-lg fa-fw"></span> Send email</a></p> 
            </div>
        </div>                    
    </div>
</footer>

      <script src="/assets/js/app.js" type="text/javascript"></script>
  </body>

</html>